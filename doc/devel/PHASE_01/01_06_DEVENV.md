https://learn.microsoft.com/ja-jp/windows-hardware/drivers/gettingstarted/writing-a-very-small-kmdf--driver


## 必要なもの　パソコン2台
- ホストマシン(コンパイラ・リンカとデバッガを動かす)(VS, WinDbg)
- ターゲットマシン(ドライバを動かす、仮想マシンでも良いが、HyprVでないとだめかもしれない)

## 1. ホストマシンに開発環境を構築する

* Visual Studio 2022をインストールする
  * MSVC v143 - VS 2022 C++ x64/x86 Spectre 軽減ライブラリ (最新)
  * Spectre 軽減策を使用した最新の v143 ビルド ツール用 C++ ATL (x86 および x64)
  * Spectre 軽減策を使用した最新の v143 ビルド ツール用 C++ MFC (x86 および x64)
  * Windows ドライバー キット
* Windows SDK最新版を導入する
* WDKの最新版を導入する



## 2. ターゲットマシンを構築する

* 仮想スイッチ(外部)を作成する
* 開発版Windows11を導入する
* 仮想マシンの動作環境を整える
  * 仮想スイッチ(外部)を接続
  * セキュアブート無効
* インストールを完了する
  * 起動、標準モードで動作させる
  * 日本語言語パックを入れて、キーボード配置を106/109にする(必要な場合)
* プロビジョニングのための準備をする
  * Windows SDK最新版を導入する
  * WDKの最新版を導入する
  * ドライバのテスト署名を許可する
    * bcdedit /set testsigning on
  * WDK テスト ターゲット セットアップを実行する
    * C:\\Program Files (x86)\\Windows Kits\\10\\Remote\\x64\\WDK Test Target Setup x64-x64\_en-us.msi

## 3. ホストとターゲット間のネットワーク通信ができることを確認する
* firewallに穴を開ける(大抵必要)
* お互いにpingができることを確認する
  * ホスト名.localで名前解決できるはず(mDNS)
  * できない場合は、ipconfigでIPアドレスを確認する



## 4. ターゲットマシンにドライバの自動配置環境を準備する(プロビジョニング)
* ホスト コンピューターの Visual Studio で、\[ 拡張機能 ] メニューを選択し、\[ ドライバー] をポイントし、\[ テスト] をポイントして、\[ デバイスの構成] を選択します。
* \[ デバイスの構成 ] ダイアログで、\[ 新しいデバイスの追加] を選択します。
* \[ネットワーク ホスト名] に、ターゲット コンピューターの名前またはローカル IP アドレスを入力します。 デバイスのプロビジョニングを選択し、デバッガーの設定を選択します。
* コンピュータを再起動します


## 5. デバイスドライバを記述する

## 6. デバイスドライバをビルドし、デプロイする
- ソリューションを選択 -> 構成マネージャ -> 構成とプラットフォーム選択(デバッグ/x64)
- プロジェクトのプロパティ設定
  - Wpp トレース > すべてのオプション で、Wpp トレースの実行 を いいえ に設定
  - Inf2Cat > General > Use Local Time　を YESに設定
- ソリューションをビルドする
  - ビルド -> ソリューションのビルド
    - 再ビルドやクリーンナップも適宜併用する
- ドライバーのデプロイ設定
  - ドライバーのインストール > デプロイメント
    - ターゲットデバイス名を、4で設定したデバイス名を選ぶ
    - 以前のバージョンのドライバーを削除する　を　ONに
    - ハードウェアIDドライバーの更新を選択し、ドライバーのハードウェアIDを入力する
      - Root\KmdfHelloWorld
      - ソリューションエクスプローラーで、プロジェクト名 > Driver Filesに移動し、*.infファイルの中に記述があるので、それと一致させる
- ドライバーをデプロイする
  - ビルド の ソリューションのデプロイを選択

## 7. ドライバーをデバッグする
- デバッガを動作させる
  - C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\ に移動
  - WinDbg -k net:port=*,key=*
    - portとkeyは、4. プロビジョニングでデバイスを作成したときに表示される値を使う






